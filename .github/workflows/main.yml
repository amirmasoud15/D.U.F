name: Persistent noVNC + Tunshell

on:
  workflow_dispatch:

jobs:
  start-novnc:
    runs-on: ubuntu-latest
    steps:
      - name: Update system and install dependencies
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tightvncserver novnc websockify curl

      - name: Start persistent session
        run: |
          # Ø±Ù…Ø² VNC
          VNC_PASS="your_vnc_password"

          # Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ú©Ù„ workflow Ø¨Ù‡ Ø«Ø§Ù†ÛŒÙ‡ (5 Ø³Ø§Ø¹Øª = 18000s)
          END=$((SECONDS+18000))

          while [ $SECONDS -lt $END ]; do
            echo "--------------------------------------------"
            echo "Starting VNC + noVNC + Tunshell..."
            echo "Time elapsed: $SECONDS seconds"
            echo "--------------------------------------------"

            # Try-Catch Ø³Ø§Ø¯Ù‡ Ø¨Ø§ bash: Ø§Ú¯Ø± Ø¯Ø³ØªÙˆØ±ÛŒ fail Ø´Ø¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡
            {
              mkdir -p ~/.vnc
              echo "$VNC_PASS" | vncpasswd -f > ~/.vnc/passwd
              chmod 600 ~/.vnc/passwd

              # Kill previous instances Ø§Ú¯Ø± Ø¨ÙˆØ¯Ù†Ø¯
              vncserver -kill :1 || true
              pkill -f websockify || true

              # Start VNC
              vncserver :1 -geometry 1280x720 -depth 24

              # Start noVNC
              websockify --web=/usr/share/novnc/ 6080 localhost:5901 &

              # Start Tunshell
              SESSION_URL=$(curl -sSf https://lets.tunshell.com/init.sh | sh -s -- \
                T Cevvg8HNK3xJEMmMXyWCjY fbfJBjUla2cwSuqyeC2XzL eu.relay.tunshell.com --print-url)

              echo "--------------------------------------------"
              echo "ğŸŒ noVNC + Tunshell is ready!"
              echo "Access your session in browser at:"
              echo "$SESSION_URL:6080/vnc.html?host=localhost&port=6080"
              echo "--------------------------------------------"

              # Keep alive for 10 minutes before retry check
              sleep 600
            } || {
              # Ø§Ú¯Ø± Ø¯Ø³ØªÙˆØ± Fail Ø´Ø¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ loop Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
              echo "âš ï¸ Something failed. Retrying in 5 seconds..."
              sleep 5
            }

          done

          echo "Workflow 5 hours completed."
